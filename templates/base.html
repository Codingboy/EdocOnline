<!doctype html>
<html lang="en">
    <head>
        {% block head %}
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
        <title>{% block title %}Edoc{% endblock title %}</title>
	<link rel="shortcut icon" href="/static/favicon.ico">
        <style>
            html
            {
                position: relative;
                min-height: 100%;
            }
            body
            {
                padding-top: 1%;
                padding-bottom: 5%;
                margin-bottom: 60px
            }
		#input
		{
			width: 75%;
		}
            .footer
            {
                position: absolute;
                bottom: 0;
                width: 100%;
                background-color: #f5f5f5;
            }
        </style>
        {% endblock head %}
		<script>
			/**
			 * Returns a random integer between min (inclusive) and max (inclusive)
			 * Using Math.round() will give you a non-uniform distribution!
			 */
			function getRandomInt(min, max)
			{
				return Math.floor(Math.random() * (max - min + 1)) + min;
			}
			class Ring
			{
				constructor(pw, offset)
				{
					this.encodeRing = new Array(256);
					this.decodeRing = new Array(256);
					this.offset = offset;
					this.pw = pw.slice();
					for (let i=0; i<256; i++)
					{
						this.encodeRing[i] = -1;
					}
					let index = 0;
					while (this.pw.length < 256)
					{
						this.pw.push(pw[index]);
						index = (index+1)%pw.length;
					}
					index = 0;
					for (let i=0; i<256; i++)
					{
						let emptyCounter = 0;
						let maxEmpty = 256-i;
						let targetEmpty = 1+(this.pw[i] % maxEmpty);
						while (emptyCounter < targetEmpty)
						{
							if (this.encodeRing[index] == -1)
							{
								emptyCounter++;
							}
							if (emptyCounter < targetEmpty)
							{
								index = (index+1)%256;
							}
						}
						this.encodeRing[index] = i;
					}
					for (let i=0; i<256; i++)
					{
						this.decodeRing[this.encodeRing[i]] = i;
					}
				}
				encode(plain)
				{
					let index = (this.offset+plain)%256;
					let encoded = this.encodeRing[index];
					this.offset = (this.offset+1)%256;
					return encoded;
				}
				decode(encoded)
				{
					let decoded = this.decodeRing[encoded] - this.offset;
					if (decoded < 0)
					{
						decoded += 256;
					}
					this.offset = (this.offset+1)%256;
					return decoded;
				}
			}
			class Torus
			{
				constructor(pw, offsets, seed)
				{
					if (typeof offsets == "undefined")
					{
						offsets = new Array(8);
						for (let i=0; i<8; i++)
						{ 
							offsets[i] = getRandomInt(0, 255);
						}
					}
					if (typeof seed == "undefined")
					{
						seed = new Array(256);
						for (let i=0; i<256; i++)
						{ 
							seed[i] = getRandomInt(1, 255);
						}
					}
					this.rings = new Array(8);
					this.seed = seed.slice();
					this.pw = pw.slice();
					for (let i=0; i<8; i++)
					{
						let ring = new Ring(this.pw, offsets[i]);
						this.rings[i] = ring;
						this.pw.push(this.pw.shift());
					}
				}
				encode256(plain)
				{
					let encoded = new Array(256);
					for (let i=0; i<256; i++)
					{
						encoded[i] = plain[i];
						for (let j=0; j<8; j++)
						{ 
							if ((this.seed[i] & (1<<j)) != 0)
							{
								let ring = this.rings[j];
								encoded[i] = ring.encode(encoded[i]);
							}
						}
						encoded[i] = encoded[i] ^ this.seed[i];
					}
					for (let j=0; j<8; j++)
					{
						let ring = this.rings[j];
						let mixed = new Array(256);
						for (let i=0; i<256; i++)
						{
							mixed[i] = encoded[i];
						}
						for (let i=0; i<256; i++)
						{
							encoded[ring.encodeRing[i]] = mixed[i];
						}
					}
					for (let i=0; i<256; i++)
					{
						this.seed[i] = encoded[i] ^ this.seed[(i+1)%256];
						if (this.seed[i] == 0)
						{
							this.seed[i] = 1;
						}
					}
					return encoded;
				}
				encode(plain)
				{
					let length = plain.length;
					while (plain.length%256 != 0)
					{
						plain.push(getRandomInt(0, 255));
					}
					let encodedBytes = 0;
					let encoded = [];
					while (encodedBytes < plain.length)
					{
						let plainPart = [];
						for (let i=0; i<256; i++)
						{
							plainPart.push(plain[encodedBytes]);
							encodedBytes++;
						}
						let encodedPart = this.encode256(plainPart);
						for (let i=0; i<256; i++)
						{
							encoded.push(encodedPart[i]);
						}
					}
					return {"length":length, "message":encoded};
				}
				decode256(encoded)
				{
					let decoded = new Array(256);
					for (let i=0; i<256; i++)
					{
						decoded[i] = encoded[i];
					}
					for (let j=8-1; j>=0; j--)
					{
						let ring = this.rings[j];
						let mixed = new Array(256);
						for (let i=0; i<256; i++)
						{
							mixed[i] = decoded[i];
						}
						for (let i=256-1; i>=0; i--)
						{
							decoded[i] = mixed[ring.encodeRing[i]];
						}
					}
					for (let i=0; i<256; i++)
					{
						decoded[i] = decoded[i] ^ this.seed[i];
						for (let j=8-1; j>=0; j--)
						{ 
							if ((this.seed[i] & (1<<j)) != 0)
							{
								let ring = this.rings[j];
								decoded[i] = ring.decode(decoded[i]);
							}
						}
					}
					for (let i=0; i<256; i++)
					{
						this.seed[i] = encoded[i] ^ this.seed[(i+1)%256];
						if (this.seed[i] == 0)
						{
							this.seed[i] = 1;
						}
					}
					return decoded;
				}
				decode(encodedJSON)
				{
					let length = encodedJSON["length"];
					let encoded = encodedJSON["message"];
					let decodedBytes = 0;
					let decoded = [];
					while (decodedBytes < encoded.length)
					{
						let encodedPart = [];
						for (let i=0; i<256; i++)
						{
							encodedPart.push(encoded[decodedBytes]);
							decodedBytes++;
						}
						let decodedPart = this.decode256(encodedPart);
						for (let i=0; i<256; i++)
						{
							if (decoded.length < length)
							{
								decoded.push(decodedPart[i]);
							}
							else
							{
								break;
							}
						}
					}
					return decoded;
				}
				getOffsets()
				{
					let offsets = [];
					for (let i=0; i<8; i++)
					{
						offsets.push(this.rings[i].offset);
					}
					return offsets;
				}
				getSeed()
				{
					let seed = [];
					for (let i=0; i<256; i++)
					{
						seed[i] = this.seed[i];
					}
					return seed;
				}
				setOffsets(offsets)
				{
					for (let i=0; i<8; i++)
					{
						this.rings[i].offset = offsets[i];
					}
				}
				setSeed(seed)
				{
					for (let i=0; i<256; i++)
					{
						this.seed[i] = seed[i];
					}
				}
			}
			function send()
			{
				let input = document.getElementById("input");
				if (input.value == "")
				{
					return;
				}
				let json = {};
				json["username"] = username;
				if (torus === null)
				{
					json["encoded"] = false;
					json["plainMessage"] = input.value;
				}
				else
				{
					let message = input.value;
					json["encoded"] = true;
					json["offsets"] = torus.getOffsets();
					json["seed"] = torus.getSeed();
					let plainMessage = [];
					for (let i=0; i<message.length; i++)
					{
						plainMessage.push(message.charCodeAt(i));
					}
					let encodedMessage = torus.encode(plainMessage);
					json["encodedMessage"] = encodedMessage;
				}
				input.value = "";
				console.log(json);
				socket.emit("sendMessage", json);
			}
			function usePassword()
			{
				let password = document.getElementById("password").value;
				if (password == "")
				{
					torus = null;
				}
				else
				{
					updatePassword(password);
				}
			}
			function usePasswordFile()
			{
				let begin = parseInt(document.getElementById("begin").value);
				let length = parseInt(document.getElementById("length").value);
				if (passwordFileContent.length >= begin+length)
				{
					let password = passwordFileContent.substring(begin, begin+length);
					updatePassword(password);
				}
				else
				{
					alert(passwordFileContent.length);
				}
			}
			function updatePassword(pw)
			{
				let asInt = [];
				for (let i=0; i<pw.length; i++)
				{
					asInt.push(pw.charCodeAt(i));
				}
				torus = new Torus(asInt);
			}
			function useUsername()
			{
				let request = db.transaction(["settings"], "readwrite").objectStore("settings").delete(0);
				request.onerror = function(event)
				{
					alert("DatabaseError");
				};
				request.onsuccess = function(event)
				{
					username = document.getElementById("username").value;
					let settings = {"id":0, "username":username};
					let req = db.transaction(["settings"], "readwrite").objectStore("settings").put(settings);
					req.onerror = function(event)
					{
						alert("DatabaseError");
					};
					req.onsuccess = function(event)
					{
					};
				};
			}
			function readSingleFile(e)
			{
				var file = e.target.files[0];
				if (!file)
				{
					return;
				}
				var reader = new FileReader();
				reader.onload = function(e)
				{
					passwordFileContent = e.target.result;
					let begin = parseInt(document.getElementById("begin").value);
					let length = parseInt(document.getElementById("length").value);
					let contentLength = passwordFileContent.length;
					if (length > contentLength)
					{
						alert("passwordfile is very small!");
					}
					else
					{
						let maxValue = contentLength-length;
						document.getElementById("begin").value = getRandomInt(0, maxValue);
						usePasswordFile();
					}
				};
				reader.readAsText(file);
			}
			function initDB(callback)
			{
				window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
				window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
				window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
				let request = window.indexedDB.open("edoc", 1);
				request.onupgradeneeded = function(event)
				{
					db = event.target.result;
					if (!db.objectStoreNames.contains("settings"))
					{
						db.createObjectStore("settings", {keyPath: "id"});
					}
				};
				request.onsuccess = function(event)
				{
					db = event.target.result;
					callback(event);
				};
				request.onerror = function(event)
				{
					alert("DBError");
				};
			}
function msToTime(duration) {
    var milliseconds = parseInt((duration%1000)/100)
        , seconds = parseInt((duration/1000)%60)
        , minutes = parseInt((duration/(1000*60))%60)
        , hours = parseInt((duration/(1000*60*60))%24);

    hours = (hours < 10) ? "0" + hours : hours;
    minutes = (minutes < 10) ? "0" + minutes : minutes;
    seconds = (seconds < 10) ? "0" + seconds : seconds;

    return hours + ":" + minutes + ":" + seconds;
}
		</script>
    </head>
    <body>
        {% block body %}
            {% block bodycontent %}
		<center>
            <div class='container'>
                <div class='row'>
                    <div class='col-xs-12'>
						<form>
							Username: <input type="text" name="username" id="username"><input type="button" value="Use Username" onclick="useUsername()"><br/>
							Password: <input type="password" name="password" id="password"><input type="button" value="Use Password" onclick="usePassword()"><br/>
							Passwordfile: <input type="file" name="passwordfile" id="passwordfile"><input type="number" name="begin" id="begin" value="0" min="0"><input type="number" name="length" id="length" value="256" min="1" max ="256"><input type="button" value="Use Passwordfile" onclick="usePasswordFile()"><br/>
							<textarea disabled rows="30" cols="126" id="output"></textarea><br/>
							<input type="text" name="input" id="input"><input type="button" value="Send" onclick="send()">
						</form>
						<script>
							let username = "Unknown User";
							document.getElementById("username").value = username;
							let torus = null;
							let passwordFileContent = "";
							document.getElementById("passwordfile").addEventListener("change", readSingleFile, false);
							let socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
							socket.open();
							socket.on("receiveMessage", function(json)
							{
								console.log(json);
								let user = json["username"];
								let encoded = json["encoded"];
								let message = "";
								let millis = json["time"];
								if (encoded)
								{
									if (torus)
									{
										let offsets = json["offsets"];
										let seed = json["seed"];
										torus.setSeed(seed);
										torus.setOffsets(offsets);
										let encodedMessage = json["encodedMessage"];
										let decodedMessage = torus.decode(encodedMessage);
										message = "<"+msToTime(millis)+">["+user+"] ";
										for (let i=0; i<decodedMessage.length; i++)
										{
											message += String.fromCharCode(decodedMessage[i]);
										}
										message += "\n";
									}
								}
								else
								{
									let plainMessage = json["plainMessage"];
									message = "<"+msToTime(millis)+">["+user+"] (unencoded) "+plainMessage+"\n";
								}
								document.getElementById("output").value += message;
							});
							let db = null;
							initDB(function(event)
							{
								let req = db.transaction(["settings"]).objectStore("settings").get(0);
								req.onerror = function(event)
								{
									alert("DatabaseError");
								};
								req.onsuccess = function(event)
								{
									if (req.result)
									{
										username = req.result["username"];
										document.getElementById("username").value = username;
									}
								};
							});
							document.getElementById("input").addEventListener ("keydown", function(event) {
								if (event.keyCode == 13)
								{
									send();
								}
							});
function testRing()
{
	let pw = [];
	let message = [];
	for (let i=0; i<256; i++)
	{ 
		pw.push(getRandomInt(0, 255));
		message.push(getRandomInt(0, 255));
	}
	let offset = getRandomInt(0, 255);
	let ring = new Ring(pw, offset);
	let encodedMessage = []
	for (let i=0; i<256; i++)
	{
		encodedMessage.push(ring.encode(message[i]));
	}
	ring = new Ring(pw, offset);
	let decodedMessage = []
	for (let i=0; i<256; i++)
	{
		decodedMessage.push(ring.decode(encodedMessage[i]));
	}
	let ok = 0;
	for (let i=0; i<256; i++)
	{
		if (decodedMessage[i] == message[i])
		{
			ok++;
		}
	}
	console.log(ok);
}
function testTorus256()
{
	let pw = [];
	let message = [];
	let offsets = [];
	let seed = [];
	let length = 256;
	for (let i=0; i<256; i++)
	{ 
		pw.push(getRandomInt(0, 255));
		offsets.push(getRandomInt(0, 255));
		seed.push(getRandomInt(1, 255));
	}
	for (let i=0; i<length; i++)
	{ 
		message.push(getRandomInt(0, 255));
	}
	let torus = new Torus(pw, offsets, seed);
	let encodedMessage = torus.encode256(message);
	torus = new Torus(pw, offsets, seed);
	let decodedMessage = torus.decode256(encodedMessage);
	let ok = 0;
	for (let i=0; i<length; i++)
	{
		if (decodedMessage[i] == message[i])
		{
			ok++;
		}
	}
	console.log(ok);
}
function testTorus(length)
{
	let pw = [];
	let message = [];
	let offsets = [];
	let seed = [];
	for (let i=0; i<256; i++)
	{ 
		pw.push(getRandomInt(0, 255));
		offsets.push(getRandomInt(0, 255));
		seed.push(getRandomInt(1, 255));
	}
	for (let i=0; i<length; i++)
	{ 
		message.push(getRandomInt(0, 255));
	}
	let torus = new Torus(pw, offsets, seed);
	let encodedMessage = torus.encode(message);
	torus = new Torus(pw, offsets, seed);
	let decodedMessage = torus.decode(encodedMessage);
	let ok = 0;
	for (let i=0; i<length; i++)
	{
		if (decodedMessage[i] == message[i])
		{
			ok++;
		}
	}
	console.log(ok);
}
testRing();
testTorus256();
testTorus(256);
testTorus(512);
						</script>
                    </div>
		</div>
            </div>
		</center>
            {% endblock bodycontent %}
            {% block footer %}
            <footer class='footer'>
		<center>
                <div class='container'>
                    <span class='text-muted'><a href='/impressum'>Impressum</a></span>
                </div>
		</center>
            </footer>
            {% endblock footer %}
        {% endblock body %}
    </body>
</html>
